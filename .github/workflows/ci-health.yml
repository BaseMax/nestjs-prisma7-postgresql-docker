name: CI Health Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      - name: Docker & system info
        run: |
          set -x
          docker version
          docker compose version
          uname -a
          df -h

      - name: Build and start services
        run: |
          set -Eeuo pipefail
          docker compose up --build -d
          echo "=== Running containers ==="
          docker ps

      - name: Wait for API port to be open
        run: |
          set -Eeuo pipefail
          echo "Waiting for API on port 4000..."
          for i in {1..30}; do
            if nc -z localhost 4000; then
              echo "API port is open."
              exit 0
            fi
            echo "[$i/30] API not ready yet..."
            sleep 2
          done

          echo "API port did not open in time."
          docker ps
          docker compose logs
          exit 1

      - name: Health check endpoints (verbose)
        run: |
          set -Eeuo pipefail
          sleep 5

          echo "===== /health ====="
          curl -v --connect-timeout 5 --max-time 10 \
            -w "\nHTTP_CODE=%{http_code}\nTOTAL_TIME=%{time_total}\n" \
            http://localhost:4000/health || true

          echo "===== /health/db ====="
          curl -v --connect-timeout 5 --max-time 10 \
            -w "\nHTTP_CODE=%{http_code}\nTOTAL_TIME=%{time_total}\n" \
            http://localhost:4000/health/db || true

          code1=$(curl -s -o /tmp/health.out -w "%{http_code}" http://localhost:4000/health || echo "000")
          code2=$(curl -s -o /tmp/healthdb.out -w "%{http_code}" http://localhost:4000/health/db || echo "000")

          echo "/health HTTP: $code1"
          echo "/health/db HTTP: $code2"

          echo "--- /health body ---"
          cat /tmp/health.out || true

          echo "--- /health/db body ---"
          cat /tmp/healthdb.out || true

          if [ "$code1" != "200" ] || [ "$code2" != "200" ]; then
            echo "Health checks failed."
            exit 1
          fi

          echo "Both health checks passed."

      - name: Dump Docker diagnostics on failure
        if: failure()
        run: |
          echo "=== docker ps ==="
          docker ps -a

          echo "=== docker compose logs ==="
          docker compose logs --no-color

          echo "=== docker inspect ==="
          docker inspect $(docker ps -aq) || true

      - name: Stop services
        if: always()
        run: |
          docker compose down -v
